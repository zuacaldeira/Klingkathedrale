<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Das Bachsche Universum — Klangkathedrale</title>
<meta name="description" content="172 CDs als Sternenkonstellation — Das vollstaendige Bachsche Universum unter Helmuth Rilling">
<meta name="theme-color" content="#1A1410">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:ital,opsz,wght@0,6..96,400;0,6..96,700;0,6..96,900;1,6..96,400&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400;1,600&display=swap" rel="stylesheet">
<link rel="manifest" href="manifest.json">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --color-gold: #C9A84C;
  --color-ink: #1A1410;
  --color-ivory: #F5F0E8;
  --color-rose: #D4725C;
  --color-sage: #6B9080;
  --color-amethyst: #8B7EC8;
  --color-amber: #C8956E;
  --color-steel: #7BA0B8;
  --font-display: 'Bodoni Moda', serif;
  --font-body: 'Cormorant Garamond', serif;
}

html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  background: #050308;
  color: var(--color-ivory);
  font-family: var(--font-body);
}

canvas { display: block; }

/* ---- TOP BAR ---- */
#topBar {
  position: fixed;
  top: 0; left: 0; right: 0;
  z-index: 100;
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem 1.5rem;
  background: linear-gradient(to bottom, rgba(5,3,8,0.92), rgba(5,3,8,0));
  pointer-events: none;
}
#topBar > * { pointer-events: auto; }

#backLink {
  color: var(--color-gold);
  text-decoration: none;
  font-family: var(--font-display);
  font-size: 0.85rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  opacity: 0.7;
  transition: opacity 0.3s;
  white-space: nowrap;
}
#backLink:hover { opacity: 1; }

#pageTitle {
  font-family: var(--font-display);
  font-size: 1rem;
  color: var(--color-gold);
  letter-spacing: 0.1em;
  opacity: 0.5;
  white-space: nowrap;
}

#searchWrap {
  flex: 1;
  max-width: 360px;
  margin-left: auto;
  position: relative;
}
#searchInput {
  width: 100%;
  padding: 0.45rem 0.8rem 0.45rem 2rem;
  background: rgba(245,240,232,0.06);
  border: 1px solid rgba(201,168,76,0.2);
  border-radius: 4px;
  color: var(--color-ivory);
  font-family: var(--font-body);
  font-size: 0.9rem;
  outline: none;
  transition: border-color 0.3s, background 0.3s;
}
#searchInput::placeholder { color: rgba(245,240,232,0.3); }
#searchInput:focus {
  border-color: var(--color-gold);
  background: rgba(245,240,232,0.1);
}
#searchIcon {
  position: absolute;
  left: 0.6rem; top: 50%;
  transform: translateY(-50%);
  color: rgba(201,168,76,0.4);
  font-size: 0.85rem;
  pointer-events: none;
}

/* ---- FILTER BAR ---- */
#filterBar {
  position: fixed;
  top: 3.2rem; left: 0; right: 0;
  z-index: 99;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0.4rem;
  padding: 0.4rem 1.5rem;
  pointer-events: none;
}
#filterBar > * { pointer-events: auto; }

.filter-btn {
  padding: 0.25rem 0.7rem;
  border: 1px solid rgba(245,240,232,0.15);
  border-radius: 3px;
  background: rgba(5,3,8,0.6);
  color: rgba(245,240,232,0.5);
  font-family: var(--font-body);
  font-size: 0.78rem;
  cursor: pointer;
  transition: all 0.3s;
  backdrop-filter: blur(4px);
  letter-spacing: 0.03em;
}
.filter-btn:hover {
  border-color: rgba(245,240,232,0.3);
  color: var(--color-ivory);
}
.filter-btn.active {
  color: #fff;
  border-color: currentColor;
}
.filter-btn[data-cat="cantatas"].active { color: var(--color-gold); background: rgba(201,168,76,0.15); }
.filter-btn[data-cat="passions"].active { color: var(--color-rose); background: rgba(212,114,92,0.15); }
.filter-btn[data-cat="oratorios"].active { color: var(--color-sage); background: rgba(107,144,128,0.15); }
.filter-btn[data-cat="masses"].active { color: var(--color-amethyst); background: rgba(139,126,200,0.15); }
.filter-btn[data-cat="instrumental"].active { color: var(--color-amber); background: rgba(200,149,110,0.15); }
.filter-btn[data-cat="organ"].active { color: var(--color-steel); background: rgba(123,160,184,0.15); }
.filter-btn[data-cat="all"].active { color: var(--color-gold); background: rgba(201,168,76,0.1); }

#constellationToggle {
  margin-left: 0.6rem;
  padding: 0.25rem 0.7rem;
  border: 1px solid rgba(201,168,76,0.25);
  border-radius: 3px;
  background: rgba(5,3,8,0.6);
  color: rgba(201,168,76,0.5);
  font-family: var(--font-body);
  font-size: 0.78rem;
  cursor: pointer;
  transition: all 0.3s;
  backdrop-filter: blur(4px);
}
#constellationToggle:hover { border-color: var(--color-gold); color: var(--color-gold); }
#constellationToggle.active {
  background: rgba(201,168,76,0.15);
  border-color: var(--color-gold);
  color: var(--color-gold);
}

/* ---- TOOLTIP ---- */
#tooltip {
  position: fixed;
  z-index: 200;
  padding: 0.55rem 0.85rem;
  background: rgba(10,8,12,0.92);
  border: 1px solid rgba(201,168,76,0.3);
  border-radius: 4px;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  backdrop-filter: blur(8px);
  max-width: 300px;
}
#tooltip.visible { opacity: 1; }
#tooltip .tt-bwv {
  font-family: var(--font-display);
  font-size: 0.75rem;
  color: var(--color-gold);
  letter-spacing: 0.08em;
  text-transform: uppercase;
}
#tooltip .tt-title {
  font-family: var(--font-body);
  font-size: 0.95rem;
  color: var(--color-ivory);
  margin-top: 0.15rem;
  line-height: 1.3;
}
#tooltip .tt-year {
  font-size: 0.75rem;
  color: rgba(245,240,232,0.4);
  margin-top: 0.2rem;
}

/* ---- DETAIL PANEL ---- */
#detailPanel {
  position: fixed;
  right: -420px;
  top: 0; bottom: 0;
  width: 400px;
  max-width: 90vw;
  z-index: 150;
  background: rgba(10,8,12,0.95);
  border-left: 1px solid rgba(201,168,76,0.2);
  backdrop-filter: blur(12px);
  overflow-y: auto;
  transition: right 0.45s cubic-bezier(0.4,0,0.2,1);
  padding: 2rem 1.5rem;
}
#detailPanel.open { right: 0; }

#detailClose {
  position: absolute;
  top: 1rem; right: 1rem;
  background: none; border: none;
  color: rgba(245,240,232,0.4);
  font-size: 1.4rem;
  cursor: pointer;
  transition: color 0.3s;
  line-height: 1;
}
#detailClose:hover { color: var(--color-gold); }

#detailPanel .dp-pattern {
  width: 100%;
  height: 200px;
  margin-bottom: 1.5rem;
  border-radius: 4px;
  overflow: hidden;
}

#detailPanel .dp-category {
  font-family: var(--font-display);
  font-size: 0.7rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin-bottom: 0.3rem;
}
#detailPanel .dp-bwv {
  font-family: var(--font-display);
  font-size: 0.8rem;
  color: var(--color-gold);
  letter-spacing: 0.1em;
  margin-bottom: 0.4rem;
}
#detailPanel .dp-title {
  font-family: var(--font-display);
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--color-ivory);
  line-height: 1.25;
  margin-bottom: 0.4rem;
}
#detailPanel .dp-year {
  font-size: 0.85rem;
  color: rgba(245,240,232,0.4);
  margin-bottom: 1.2rem;
}
#detailPanel .dp-tracks {
  margin-bottom: 1.2rem;
}
#detailPanel .dp-tracks h4 {
  font-family: var(--font-display);
  font-size: 0.75rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: rgba(245,240,232,0.4);
  margin-bottom: 0.5rem;
}
#detailPanel .dp-tracks ol {
  padding-left: 1.2rem;
  color: rgba(245,240,232,0.6);
  font-size: 0.88rem;
  line-height: 1.6;
}
#detailPanel .dp-link {
  display: inline-block;
  padding: 0.5rem 1.2rem;
  border: 1px solid var(--color-gold);
  border-radius: 3px;
  color: var(--color-gold);
  text-decoration: none;
  font-family: var(--font-display);
  font-size: 0.8rem;
  letter-spacing: 0.08em;
  transition: all 0.3s;
  margin-top: 0.3rem;
}
#detailPanel .dp-link:hover {
  background: var(--color-gold);
  color: var(--color-ink);
}

/* ---- STATS ---- */
#stats {
  position: fixed;
  bottom: 1rem; left: 1.5rem;
  z-index: 100;
  font-size: 0.72rem;
  color: rgba(245,240,232,0.25);
  font-family: var(--font-body);
  letter-spacing: 0.04em;
  pointer-events: none;
}

/* ---- LOADING ---- */
#loadingOverlay {
  position: fixed;
  inset: 0;
  z-index: 9999;
  background: #050308;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: opacity 1.2s;
}
#loadingOverlay.fade { opacity: 0; pointer-events: none; }
#loadingOverlay .lo-title {
  font-family: var(--font-display);
  font-size: 1.6rem;
  color: var(--color-gold);
  letter-spacing: 0.2em;
  text-transform: uppercase;
  margin-bottom: 0.5rem;
}
#loadingOverlay .lo-sub {
  font-family: var(--font-body);
  font-size: 1rem;
  color: rgba(245,240,232,0.4);
  margin-bottom: 2rem;
}
#loadingOverlay .lo-bar {
  width: 200px;
  height: 2px;
  background: rgba(245,240,232,0.1);
  border-radius: 1px;
  overflow: hidden;
}
#loadingOverlay .lo-fill {
  width: 0%;
  height: 100%;
  background: var(--color-gold);
  transition: width 0.3s;
}

/* ---- LEGEND ---- */
#legend {
  position: fixed;
  bottom: 1rem; right: 1.5rem;
  z-index: 100;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  pointer-events: none;
}
.legend-item {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  font-size: 0.7rem;
  color: rgba(245,240,232,0.35);
}
.legend-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
}

/* ---- SCROLLBAR ---- */
#detailPanel::-webkit-scrollbar { width: 4px; }
#detailPanel::-webkit-scrollbar-track { background: transparent; }
#detailPanel::-webkit-scrollbar-thumb { background: rgba(201,168,76,0.2); border-radius: 2px; }

@media (max-width: 768px) {
  #topBar { padding: 0.5rem 0.8rem; gap: 0.5rem; }
  #pageTitle { display: none; }
  #searchWrap { max-width: 200px; }
  #filterBar { top: 2.8rem; padding: 0.3rem 0.8rem; gap: 0.3rem; }
  .filter-btn { font-size: 0.68rem; padding: 0.2rem 0.5rem; }
  #detailPanel { width: 100%; max-width: 100vw; }
  #legend { display: none; }
}
</style>
</head>
<body>

<!-- Loading overlay -->
<div id="loadingOverlay">
  <div class="lo-title">Das Bachsche Universum</div>
  <div class="lo-sub">172 Aufnahmen unter Helmuth Rilling</div>
  <div class="lo-bar"><div class="lo-fill" id="loadFill"></div></div>
</div>

<!-- Top bar -->
<div id="topBar">
  <a href="klangkathedrale.html" id="backLink">&larr; Klangkathedrale</a>
  <span id="pageTitle">Das Bachsche Universum</span>
  <div id="searchWrap">
    <span id="searchIcon">&#9906;</span>
    <input type="text" id="searchInput" placeholder="Suche nach BWV, Titel, Kategorie...">
  </div>
</div>

<!-- Filter bar -->
<div id="filterBar">
  <button class="filter-btn active" data-cat="all">Alle (172)</button>
  <button class="filter-btn" data-cat="cantatas">Kantaten (~60)</button>
  <button class="filter-btn" data-cat="passions">Passionen (~5)</button>
  <button class="filter-btn" data-cat="oratorios">Oratorien (~8)</button>
  <button class="filter-btn" data-cat="masses">Messen (~12)</button>
  <button class="filter-btn" data-cat="instrumental">Instrumental (~55)</button>
  <button class="filter-btn" data-cat="organ">Orgel (~32)</button>
  <button id="constellationToggle">Konstellationen</button>
</div>

<!-- Tooltip -->
<div id="tooltip">
  <div class="tt-bwv"></div>
  <div class="tt-title"></div>
  <div class="tt-year"></div>
</div>

<!-- Detail panel -->
<div id="detailPanel">
  <button id="detailClose">&times;</button>
  <canvas class="dp-pattern" id="patternCanvas"></canvas>
  <div class="dp-category" id="dpCategory"></div>
  <div class="dp-bwv" id="dpBwv"></div>
  <div class="dp-title" id="dpTitle"></div>
  <div class="dp-year" id="dpYear"></div>
  <div class="dp-tracks" id="dpTracks">
    <h4>Satzfolge</h4>
    <ol id="dpTrackList"></ol>
  </div>
  <div style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.3rem">
    <a class="dp-link" id="dpYouTube" href="#" target="_blank" rel="noopener">YouTube &rarr;</a>
    <a class="dp-link" id="dpSpotify" href="#" target="_blank" rel="noopener">Spotify &rarr;</a>
    <a class="dp-link" id="dpAmazon" href="#" target="_blank" rel="noopener">Amazon &rarr;</a>
  </div>
</div>

<!-- Stats -->
<div id="stats">172 CDs &middot; 60fps</div>

<!-- Legend -->
<div id="legend">
  <div class="legend-item"><span class="legend-dot" style="background:#C9A84C"></span>Kantaten</div>
  <div class="legend-item"><span class="legend-dot" style="background:#D4725C"></span>Passionen</div>
  <div class="legend-item"><span class="legend-dot" style="background:#6B9080"></span>Oratorien</div>
  <div class="legend-item"><span class="legend-dot" style="background:#8B7EC8"></span>Messen</div>
  <div class="legend-item"><span class="legend-dot" style="background:#C8956E"></span>Instrumental</div>
  <div class="legend-item"><span class="legend-dot" style="background:#7BA0B8"></span>Orgel</div>
</div>

<script type="module">import './src/lib/nav.js';</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ============================================================
// DATA: 172 Bach works recorded by Helmuth Rilling
// ============================================================
const WORKS = [
  // ---- CANTATAS (~60) ---- spiral arm
  {bwv:"BWV 1",title:"Wie schoen leuchtet der Morgenstern",cat:"cantatas",year:"1725",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 2",title:"Ach Gott, vom Himmel sieh darein",cat:"cantatas",year:"1724",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 4",title:"Christ lag in Todes Banden",cat:"cantatas",year:"1707",tracks:["Sinfonia","Versus I","Versus II","Versus III","Versus IV","Versus V","Versus VI","Versus VII"]},
  {bwv:"BWV 6",title:"Bleib bei uns, denn es will Abend werden",cat:"cantatas",year:"1725",tracks:["Coro","Aria","Choral","Recitativo","Aria","Choral"]},
  {bwv:"BWV 8",title:"Liebster Gott, wenn werd ich sterben?",cat:"cantatas",year:"1724",tracks:["Coro","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 10",title:"Meine Seel erhebt den Herren",cat:"cantatas",year:"1724",tracks:["Coro","Aria","Recitativo","Aria","Duetto","Choral"]},
  {bwv:"BWV 12",title:"Weinen, Klagen, Sorgen, Zagen",cat:"cantatas",year:"1714",tracks:["Sinfonia","Coro","Recitativo","Aria","Aria","Aria","Choral"]},
  {bwv:"BWV 19",title:"Es erhub sich ein Streit",cat:"cantatas",year:"1726",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Recitativo","Choral"]},
  {bwv:"BWV 21",title:"Ich hatte viel Bekuemmernis",cat:"cantatas",year:"1714",tracks:["Sinfonia","Coro","Aria","Recitativo","Aria","Coro","Recitativo","Aria","Coro","Aria","Coro"]},
  {bwv:"BWV 23",title:"Du wahrer Gott und Davids Sohn",cat:"cantatas",year:"1723",tracks:["Aria","Recitativo","Coro","Choral"]},
  {bwv:"BWV 26",title:"Ach wie fluechtig, ach wie nichtig",cat:"cantatas",year:"1724",tracks:["Coro","Aria","Recitativo","Aria","Recitativo","Choral"]},
  {bwv:"BWV 29",title:"Wir danken dir, Gott, wir danken dir",cat:"cantatas",year:"1731",tracks:["Sinfonia","Coro","Aria","Recitativo","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 31",title:"Der Himmel lacht! Die Erde jubilieret",cat:"cantatas",year:"1715",tracks:["Sonata","Coro","Recitativo","Aria","Recitativo","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 34",title:"O ewiges Feuer, o Ursprung der Liebe",cat:"cantatas",year:"1727",tracks:["Coro","Recitativo","Aria","Recitativo","Coro"]},
  {bwv:"BWV 38",title:"Aus tiefer Not schrei ich zu dir",cat:"cantatas",year:"1724",tracks:["Coro","Recitativo","Aria","Recitativo","Terzetto","Choral"]},
  {bwv:"BWV 39",title:"Brich dem Hungrigen dein Brot",cat:"cantatas",year:"1726",tracks:["Coro","Recitativo","Aria","Aria","Aria","Recitativo","Choral"]},
  {bwv:"BWV 40",title:"Dazu ist erschienen der Sohn Gottes",cat:"cantatas",year:"1723",tracks:["Coro","Recitativo","Choral","Aria","Recitativo","Choral","Aria","Choral"]},
  {bwv:"BWV 45",title:"Es ist dir gesagt, Mensch, was gut ist",cat:"cantatas",year:"1726",tracks:["Coro","Recitativo","Aria","Arioso","Aria","Recitativo","Choral"]},
  {bwv:"BWV 51",title:"Jauchzet Gott in allen Landen!",cat:"cantatas",year:"1730",tracks:["Aria","Recitativo","Aria","Choral","Aria"]},
  {bwv:"BWV 54",title:"Widerstehe doch der Suende",cat:"cantatas",year:"1714",tracks:["Aria","Recitativo","Aria"]},
  {bwv:"BWV 56",title:"Ich will den Kreuzstab gerne tragen",cat:"cantatas",year:"1726",tracks:["Aria","Recitativo","Aria","Recitativo","Choral"]},
  {bwv:"BWV 61",title:"Nun komm, der Heiden Heiland (I)",cat:"cantatas",year:"1714",tracks:["Ouverture","Recitativo","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 62",title:"Nun komm, der Heiden Heiland (II)",cat:"cantatas",year:"1724",tracks:["Coro","Aria","Recitativo","Aria","Recitativo","Choral"]},
  {bwv:"BWV 67",title:"Halt im Gedaechtnis Jesum Christ",cat:"cantatas",year:"1724",tracks:["Coro","Aria","Recitativo","Choral","Recitativo","Aria","Choral"]},
  {bwv:"BWV 68",title:"Also hat Gott die Welt geliebt",cat:"cantatas",year:"1725",tracks:["Coro","Aria","Recitativo","Aria","Coro"]},
  {bwv:"BWV 70",title:"Wachet! betet! betet! wachet!",cat:"cantatas",year:"1723",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Recitativo","Coro","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 76",title:"Die Himmel erzaehlen die Ehre Gottes",cat:"cantatas",year:"1723",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Recitativo","Choral","Sinfonia","Recitativo","Aria","Recitativo","Aria","Recitativo","Choral"]},
  {bwv:"BWV 78",title:"Jesu, der du meine Seele",cat:"cantatas",year:"1724",tracks:["Coro","Duetto","Recitativo","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 80",title:"Ein feste Burg ist unser Gott",cat:"cantatas",year:"1730",tracks:["Coro","Aria","Recitativo","Aria","Coro","Recitativo","Duetto","Choral"]},
  {bwv:"BWV 82",title:"Ich habe genug",cat:"cantatas",year:"1727",tracks:["Aria","Recitativo","Aria","Recitativo","Aria"]},
  {bwv:"BWV 93",title:"Wer nur den lieben Gott laesst walten",cat:"cantatas",year:"1724",tracks:["Coro","Recitativo","Aria","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 99",title:"Was Gott tut, das ist wohlgetan (I)",cat:"cantatas",year:"1724",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 100",title:"Was Gott tut, das ist wohlgetan (II)",cat:"cantatas",year:"1732",tracks:["Coro","Duetto","Aria","Aria","Recitativo","Coro"]},
  {bwv:"BWV 104",title:"Du Hirte Israel, hoere",cat:"cantatas",year:"1724",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 105",title:"Herr, gehe nicht ins Gericht",cat:"cantatas",year:"1723",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 106",title:"Gottes Zeit ist die allerbeste Zeit",cat:"cantatas",year:"1707",tracks:["Sonatina","Coro","Aria","Arioso","Coro"]},
  {bwv:"BWV 110",title:"Unser Mund sei voll Lachens",cat:"cantatas",year:"1725",tracks:["Coro","Aria","Recitativo","Aria","Duetto","Aria","Choral"]},
  {bwv:"BWV 115",title:"Mache dich, mein Geist, bereit",cat:"cantatas",year:"1724",tracks:["Coro","Aria","Recitativo","Aria","Recitativo","Choral"]},
  {bwv:"BWV 119",title:"Preise, Jerusalem, den Herrn",cat:"cantatas",year:"1723",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Recitativo","Coro","Recitativo","Coro"]},
  {bwv:"BWV 130",title:"Herr Gott, dich loben alle wir",cat:"cantatas",year:"1724",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 131",title:"Aus der Tiefen rufe ich, Herr, zu dir",cat:"cantatas",year:"1707",tracks:["Coro","Arioso","Coro","Aria","Coro"]},
  {bwv:"BWV 137",title:"Lobe den Herren, den maechtigen Koenig",cat:"cantatas",year:"1725",tracks:["Coro","Aria","Aria","Aria","Choral"]},
  {bwv:"BWV 140",title:"Wachet auf, ruft uns die Stimme",cat:"cantatas",year:"1731",tracks:["Coro","Recitativo","Duetto","Choral","Recitativo","Duetto","Choral"]},
  {bwv:"BWV 143",title:"Lobe den Herrn, meine Seele (I)",cat:"cantatas",year:"1735",tracks:["Coro","Choral","Recitativo","Aria","Aria","Aria","Choral"]},
  {bwv:"BWV 147",title:"Herz und Mund und Tat und Leben",cat:"cantatas",year:"1723",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Choral","Aria","Recitativo","Aria","Choral"]},
  {bwv:"BWV 150",title:"Nach dir, Herr, verlanget mich",cat:"cantatas",year:"1707",tracks:["Sinfonia","Coro","Aria","Coro","Aria","Coro","Coro"]},
  {bwv:"BWV 151",title:"Suesser Trost, mein Jesus koemmt",cat:"cantatas",year:"1725",tracks:["Aria","Recitativo","Aria","Recitativo","Choral"]},
  {bwv:"BWV 155",title:"Mein Gott, wie lang, ach lange?",cat:"cantatas",year:"1716",tracks:["Recitativo","Duetto","Recitativo","Aria","Choral"]},
  {bwv:"BWV 161",title:"Komm, du suesse Todesstunde",cat:"cantatas",year:"1716",tracks:["Aria","Recitativo","Aria","Recitativo","Coro","Choral"]},
  {bwv:"BWV 170",title:"Vergnuegte Ruh, beliebte Seelenlust",cat:"cantatas",year:"1726",tracks:["Aria","Recitativo","Aria","Recitativo","Aria"]},
  {bwv:"BWV 172",title:"Erschallet, ihr Lieder",cat:"cantatas",year:"1714",tracks:["Coro","Recitativo","Aria","Aria","Duetto","Choral"]},
  {bwv:"BWV 180",title:"Schmuecke dich, o liebe Seele",cat:"cantatas",year:"1724",tracks:["Coro","Aria","Recitativo","Recitativo","Aria","Recitativo","Choral"]},
  {bwv:"BWV 182",title:"Himmelskoenig, sei willkommen",cat:"cantatas",year:"1714",tracks:["Sonata","Coro","Recitativo","Aria","Aria","Aria","Choral","Coro"]},
  {bwv:"BWV 187",title:"Es wartet alles auf dich",cat:"cantatas",year:"1726",tracks:["Coro","Recitativo","Aria","Aria","Aria","Recitativo","Choral"]},
  {bwv:"BWV 191",title:"Gloria in excelsis Deo",cat:"cantatas",year:"1745",tracks:["Coro","Duetto","Coro"]},
  {bwv:"BWV 196",title:"Der Herr denket an uns",cat:"cantatas",year:"1708",tracks:["Sinfonia","Coro","Aria","Duetto","Coro"]},
  {bwv:"BWV 198",title:"Lass, Fuerstin, lass noch einen Strahl",cat:"cantatas",year:"1727",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Recitativo","Coro","Aria","Recitativo","Coro"]},
  {bwv:"BWV 199",title:"Mein Herze schwimmt im Blut",cat:"cantatas",year:"1714",tracks:["Recitativo","Aria","Recitativo","Aria","Recitativo","Choral","Recitativo","Aria"]},
  {bwv:"BWV 202",title:"Weichet nur, betruebte Schatten",cat:"cantatas",year:"1718",tracks:["Aria","Recitativo","Aria","Recitativo","Aria","Recitativo","Aria","Recitativo","Aria"]},
  {bwv:"BWV 211",title:"Schweigt stille, plaudert nicht (Kaffeekantate)",cat:"cantatas",year:"1735",tracks:["Recitativo","Aria","Recitativo","Aria","Recitativo","Aria","Recitativo","Aria","Recitativo","Terzetto"]},
  // ---- PASSIONS (~5) ---- center, brightest
  {bwv:"BWV 244",title:"Matthaeus-Passion",cat:"passions",year:"1727",tracks:["Kommt, ihr Toechter, helft mir klagen","Da Jesus diese Rede vollendet hatte","Herzliebster Jesu","Da versammelten sich die Hohenpriester","Ja nicht auf das Fest","Du lieber Heiland du","Buss und Reu","Da nun Jesus war zu Bethanien","Erbarme dich, mein Gott","Sind Blitze, sind Donner","Wir setzen uns mit Traenen nieder"]},
  {bwv:"BWV 245",title:"Johannes-Passion",cat:"passions",year:"1724",tracks:["Herr, unser Herrscher","Jesus ging mit seinen Juengern","Von den Stricken meiner Suenden","Ach, mein Sinn","Betrachte, meine Seel","Erwage, wie sein blutgefaerbter Ruecken","Es ist vollbracht","Mein teurer Heiland","Ruht wohl, ihr heiligen Gebeine"]},
  {bwv:"BWV 247",title:"Markus-Passion (Rekonstruktion)",cat:"passions",year:"1731",tracks:["Eingangschor","Recitativo","Aria","Choral","Recitativo","Aria","Schlusschor"]},
  {bwv:"BWV 246",title:"Lukas-Passion (zugeschrieben)",cat:"passions",year:"1730",tracks:["Eingangschor","Erzaehler","Choraele","Arien","Schlusschor"]},
  {bwv:"BWV 249",title:"Oster-Oratorium",cat:"passions",year:"1725",tracks:["Sinfonia","Adagio","Coro","Recitativo","Aria","Recitativo","Aria","Recitativo","Aria","Recitativo","Coro"]},
  // ---- ORATORIOS (~8) ----
  {bwv:"BWV 248",title:"Weihnachts-Oratorium",cat:"oratorios",year:"1734",tracks:["Jauchzet, frohlocket!","Grosser Herr, o starker Koenig","Bereite dich, Zion","Ehre sei Gott in der Hoehe","Herrscher des Himmels, erhoere das Lallen","Fallt mit Danken, fallt mit Loben"]},
  {bwv:"BWV 11",title:"Himmelfahrts-Oratorium",cat:"oratorios",year:"1735",tracks:["Coro","Recitativo","Recitativo","Aria","Recitativo","Choral","Recitativo","Recitativo","Aria","Recitativo","Choral"]},
  {bwv:"BWV 249a",title:"Entfliehet, verschwindet (Schaefer-Kantate)",cat:"oratorios",year:"1725",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Recitativo","Duetto","Coro"]},
  {bwv:"BWV 207",title:"Vereinigte Zwietracht der wechselnden Saiten",cat:"oratorios",year:"1726",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Recitativo","Coro","Marcia"]},
  {bwv:"BWV 207a",title:"Auf, schmetternde Toene der muntern Trompeten",cat:"oratorios",year:"1735",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Recitativo","Coro","Marcia"]},
  {bwv:"BWV 208",title:"Was mir behagt, ist nur die muntre Jagd (Jagdkantate)",cat:"oratorios",year:"1713",tracks:["Recitativo","Aria","Recitativo","Aria","Recitativo","Recitativo","Aria","Recitativo","Aria","Recitativo","Coro","Aria","Duetto","Coro"]},
  {bwv:"BWV 213",title:"Lasst uns sorgen, lasst uns wachen (Herkules)",cat:"oratorios",year:"1733",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Recitativo","Aria","Recitativo","Duetto","Recitativo","Aria","Recitativo","Coro"]},
  {bwv:"BWV 214",title:"Toenet, ihr Pauken! Erschallet, Trompeten!",cat:"oratorios",year:"1733",tracks:["Coro","Recitativo","Aria","Recitativo","Aria","Recitativo","Aria","Recitativo","Coro"]},
  // ---- MASSES (~12) ----
  {bwv:"BWV 232",title:"Messe in h-Moll",cat:"masses",year:"1749",tracks:["Kyrie eleison","Christe eleison","Kyrie eleison II","Gloria in excelsis","Et in terra pax","Laudamus te","Gratias agimus","Domine Deus","Qui tollis","Qui sedes","Quoniam","Cum Sancto Spiritu","Credo in unum Deum","Patrem omnipotentem","Et in unum Dominum","Et incarnatus est","Crucifixus","Et resurrexit","Et in Spiritum Sanctum","Confiteor","Et expecto","Sanctus","Osanna","Benedictus","Agnus Dei","Dona nobis pacem"]},
  {bwv:"BWV 233",title:"Missa in F-Dur",cat:"masses",year:"1740",tracks:["Kyrie","Gloria","Domine Deus","Qui tollis","Quoniam","Cum Sancto Spiritu"]},
  {bwv:"BWV 234",title:"Missa in A-Dur",cat:"masses",year:"1738",tracks:["Kyrie","Gloria","Domine Deus","Qui tollis","Quoniam","Cum Sancto Spiritu"]},
  {bwv:"BWV 235",title:"Missa in g-Moll",cat:"masses",year:"1737",tracks:["Kyrie","Gloria","Domine Deus","Qui tollis","Quoniam","Cum Sancto Spiritu"]},
  {bwv:"BWV 236",title:"Missa in G-Dur",cat:"masses",year:"1738",tracks:["Kyrie","Gloria","Domine Deus","Qui tollis","Quoniam","Cum Sancto Spiritu"]},
  {bwv:"BWV 237",title:"Sanctus in C-Dur",cat:"masses",year:"1723",tracks:["Sanctus"]},
  {bwv:"BWV 238",title:"Sanctus in D-Dur",cat:"masses",year:"1723",tracks:["Sanctus"]},
  {bwv:"BWV 243",title:"Magnificat in D-Dur",cat:"masses",year:"1733",tracks:["Magnificat anima mea","Et exsultavit","Quia respexit","Omnes generationes","Quia fecit mihi magna","Et misericordia","Fecit potentiam","Deposuit potentes","Esurientes implevit","Suscepit Israel","Sicut locutus est","Gloria Patri"]},
  {bwv:"BWV 243a",title:"Magnificat in Es-Dur",cat:"masses",year:"1723",tracks:["Magnificat","Et exsultavit","Quia respexit","Omnes generationes","Quia fecit","Et misericordia","Fecit potentiam","Deposuit","Esurientes","Suscepit","Sicut locutus","Gloria Patri"]},
  {bwv:"BWV 118",title:"O Jesu Christ, meins Lebens Licht (Motette)",cat:"masses",year:"1736",tracks:["Coro"]},
  {bwv:"BWV 225",title:"Singet dem Herrn ein neues Lied (Motette)",cat:"masses",year:"1727",tracks:["Coro I","Aria","Coro II"]},
  {bwv:"BWV 227",title:"Jesu, meine Freude (Motette)",cat:"masses",year:"1723",tracks:["Choral","Es ist nun nichts","Unter deinem Schirmen","Denn das Gesetz","Trotz dem alten Drachen","Ihr aber seid nicht fleischlich","Weg mit allen Schaetzen","So aber Christus in euch ist","Gute Nacht, o Wesen","So nun der Geist","Weicht, ihr Trauergeister"]},
  // ---- INSTRUMENTAL (~55) ----
  {bwv:"BWV 1041",title:"Violinkonzert in a-Moll",cat:"instrumental",year:"1730",tracks:["Allegro","Andante","Allegro assai"]},
  {bwv:"BWV 1042",title:"Violinkonzert in E-Dur",cat:"instrumental",year:"1730",tracks:["Allegro","Adagio","Allegro assai"]},
  {bwv:"BWV 1043",title:"Konzert fuer 2 Violinen in d-Moll",cat:"instrumental",year:"1730",tracks:["Vivace","Largo ma non tanto","Allegro"]},
  {bwv:"BWV 1044",title:"Tripelkonzert in a-Moll",cat:"instrumental",year:"1738",tracks:["Allegro","Adagio ma non tanto e dolce","Tempo di Allabreve"]},
  {bwv:"BWV 1046",title:"Brandenburgisches Konzert Nr. 1 in F-Dur",cat:"instrumental",year:"1721",tracks:["Allegro","Adagio","Allegro","Menuetto - Trio - Polacca"]},
  {bwv:"BWV 1047",title:"Brandenburgisches Konzert Nr. 2 in F-Dur",cat:"instrumental",year:"1721",tracks:["Allegro","Andante","Allegro assai"]},
  {bwv:"BWV 1048",title:"Brandenburgisches Konzert Nr. 3 in G-Dur",cat:"instrumental",year:"1721",tracks:["Allegro","Adagio","Allegro"]},
  {bwv:"BWV 1049",title:"Brandenburgisches Konzert Nr. 4 in G-Dur",cat:"instrumental",year:"1721",tracks:["Allegro","Andante","Presto"]},
  {bwv:"BWV 1050",title:"Brandenburgisches Konzert Nr. 5 in D-Dur",cat:"instrumental",year:"1721",tracks:["Allegro","Affettuoso","Allegro"]},
  {bwv:"BWV 1051",title:"Brandenburgisches Konzert Nr. 6 in B-Dur",cat:"instrumental",year:"1721",tracks:["Allegro","Adagio ma non tanto","Allegro"]},
  {bwv:"BWV 1052",title:"Cembalokonzert Nr. 1 in d-Moll",cat:"instrumental",year:"1738",tracks:["Allegro","Adagio","Allegro"]},
  {bwv:"BWV 1053",title:"Cembalokonzert Nr. 2 in E-Dur",cat:"instrumental",year:"1738",tracks:["Allegro","Siciliano","Allegro"]},
  {bwv:"BWV 1054",title:"Cembalokonzert Nr. 3 in D-Dur",cat:"instrumental",year:"1738",tracks:["Allegro","Adagio e piano sempre","Allegro"]},
  {bwv:"BWV 1055",title:"Cembalokonzert Nr. 4 in A-Dur",cat:"instrumental",year:"1738",tracks:["Allegro","Larghetto","Allegro ma non tanto"]},
  {bwv:"BWV 1056",title:"Cembalokonzert Nr. 5 in f-Moll",cat:"instrumental",year:"1738",tracks:["Allegro","Largo","Presto"]},
  {bwv:"BWV 1057",title:"Cembalokonzert Nr. 6 in F-Dur",cat:"instrumental",year:"1738",tracks:["Allegro","Andante","Allegro assai"]},
  {bwv:"BWV 1058",title:"Cembalokonzert Nr. 7 in g-Moll",cat:"instrumental",year:"1738",tracks:["Allegro","Andante","Allegro assai"]},
  {bwv:"BWV 1060",title:"Konzert fuer 2 Cembali in c-Moll",cat:"instrumental",year:"1736",tracks:["Allegro","Adagio","Allegro"]},
  {bwv:"BWV 1061",title:"Konzert fuer 2 Cembali in C-Dur",cat:"instrumental",year:"1736",tracks:["Allegro","Adagio ovvero Largo","Fuga"]},
  {bwv:"BWV 1062",title:"Konzert fuer 2 Cembali in c-Moll",cat:"instrumental",year:"1736",tracks:["Allegro","Andante e piano","Allegro assai"]},
  {bwv:"BWV 1063",title:"Konzert fuer 3 Cembali in d-Moll",cat:"instrumental",year:"1730",tracks:["Allegro","Alla Siciliana","Allegro"]},
  {bwv:"BWV 1064",title:"Konzert fuer 3 Cembali in C-Dur",cat:"instrumental",year:"1730",tracks:["Allegro","Adagio","Allegro"]},
  {bwv:"BWV 1065",title:"Konzert fuer 4 Cembali in a-Moll",cat:"instrumental",year:"1730",tracks:["Allegro","Largo","Allegro"]},
  {bwv:"BWV 1066",title:"Orchestersuite Nr. 1 in C-Dur",cat:"instrumental",year:"1725",tracks:["Ouverture","Courante","Gavotte I/II","Forlane","Menuett I/II","Bourree I/II","Passepied I/II"]},
  {bwv:"BWV 1067",title:"Orchestersuite Nr. 2 in h-Moll",cat:"instrumental",year:"1738",tracks:["Ouverture","Rondeau","Sarabande","Bourree I/II","Polonaise","Menuett","Badinerie"]},
  {bwv:"BWV 1068",title:"Orchestersuite Nr. 3 in D-Dur",cat:"instrumental",year:"1731",tracks:["Ouverture","Air","Gavotte I/II","Bourree","Gigue"]},
  {bwv:"BWV 1069",title:"Orchestersuite Nr. 4 in D-Dur",cat:"instrumental",year:"1725",tracks:["Ouverture","Bourree I/II","Gavotte","Menuett I/II","Rejouissance"]},
  {bwv:"BWV 1001",title:"Sonata Nr. 1 fuer Violine solo in g-Moll",cat:"instrumental",year:"1720",tracks:["Adagio","Fuga","Siciliana","Presto"]},
  {bwv:"BWV 1002",title:"Partita Nr. 1 fuer Violine solo in h-Moll",cat:"instrumental",year:"1720",tracks:["Allemanda","Double","Corrente","Double","Sarabande","Double","Tempo di Borea","Double"]},
  {bwv:"BWV 1003",title:"Sonata Nr. 2 fuer Violine solo in a-Moll",cat:"instrumental",year:"1720",tracks:["Grave","Fuga","Andante","Allegro"]},
  {bwv:"BWV 1004",title:"Partita Nr. 2 fuer Violine solo in d-Moll",cat:"instrumental",year:"1720",tracks:["Allemanda","Corrente","Sarabanda","Giga","Ciaccona"]},
  {bwv:"BWV 1005",title:"Sonata Nr. 3 fuer Violine solo in C-Dur",cat:"instrumental",year:"1720",tracks:["Adagio","Fuga","Largo","Allegro assai"]},
  {bwv:"BWV 1006",title:"Partita Nr. 3 fuer Violine solo in E-Dur",cat:"instrumental",year:"1720",tracks:["Preludio","Loure","Gavotte en rondeau","Menuett I/II","Bourree","Gigue"]},
  {bwv:"BWV 1007",title:"Suite fuer Violoncello solo Nr. 1 in G-Dur",cat:"instrumental",year:"1720",tracks:["Prelude","Allemande","Courante","Sarabande","Menuett I/II","Gigue"]},
  {bwv:"BWV 1008",title:"Suite fuer Violoncello solo Nr. 2 in d-Moll",cat:"instrumental",year:"1720",tracks:["Prelude","Allemande","Courante","Sarabande","Menuett I/II","Gigue"]},
  {bwv:"BWV 1009",title:"Suite fuer Violoncello solo Nr. 3 in C-Dur",cat:"instrumental",year:"1720",tracks:["Prelude","Allemande","Courante","Sarabande","Bourree I/II","Gigue"]},
  {bwv:"BWV 1010",title:"Suite fuer Violoncello solo Nr. 4 in Es-Dur",cat:"instrumental",year:"1720",tracks:["Prelude","Allemande","Courante","Sarabande","Bourree I/II","Gigue"]},
  {bwv:"BWV 1011",title:"Suite fuer Violoncello solo Nr. 5 in c-Moll",cat:"instrumental",year:"1720",tracks:["Prelude","Allemande","Courante","Sarabande","Gavotte I/II","Gigue"]},
  {bwv:"BWV 1012",title:"Suite fuer Violoncello solo Nr. 6 in D-Dur",cat:"instrumental",year:"1720",tracks:["Prelude","Allemande","Courante","Sarabande","Gavotte I/II","Gigue"]},
  {bwv:"BWV 1079",title:"Musikalisches Opfer",cat:"instrumental",year:"1747",tracks:["Ricercar a 3","Canon perpetuus","Canones diversi","Sonata sopr'il Soggetto Reale","Ricercar a 6","Canon perpetuus"]},
  {bwv:"BWV 1080",title:"Die Kunst der Fuge",cat:"instrumental",year:"1749",tracks:["Contrapunctus I","Contrapunctus II","Contrapunctus III","Contrapunctus IV","Contrapunctus V","Contrapunctus VI","Contrapunctus VII","Contrapunctus VIII","Contrapunctus IX","Contrapunctus X","Contrapunctus XI","Contrapunctus XII","Contrapunctus XIII","Contrapunctus XIV (unvollendet)"]},
  {bwv:"BWV 988",title:"Goldberg-Variationen",cat:"instrumental",year:"1741",tracks:["Aria","Variatio 1-30","Aria da Capo"]},
  {bwv:"BWV 846",title:"Das Wohltemperierte Klavier I (Auswahl)",cat:"instrumental",year:"1722",tracks:["Praeludium & Fuge C-Dur","Praeludium & Fuge c-Moll","Praeludium & Fuge D-Dur","Praeludium & Fuge d-Moll"]},
  {bwv:"BWV 870",title:"Das Wohltemperierte Klavier II (Auswahl)",cat:"instrumental",year:"1742",tracks:["Praeludium & Fuge C-Dur","Praeludium & Fuge c-Moll","Praeludium & Fuge D-Dur","Praeludium & Fuge d-Moll"]},
  {bwv:"BWV 825",title:"Partita Nr. 1 fuer Klavier in B-Dur",cat:"instrumental",year:"1726",tracks:["Praeludium","Allemande","Corrente","Sarabande","Menuett I/II","Gigue"]},
  {bwv:"BWV 826",title:"Partita Nr. 2 fuer Klavier in c-Moll",cat:"instrumental",year:"1727",tracks:["Sinfonia","Allemande","Courante","Sarabande","Rondeaux","Capriccio"]},
  {bwv:"BWV 827",title:"Partita Nr. 3 fuer Klavier in a-Moll",cat:"instrumental",year:"1727",tracks:["Fantasia","Allemande","Corrente","Sarabande","Burlesca","Scherzo","Gigue"]},
  {bwv:"BWV 828",title:"Partita Nr. 4 fuer Klavier in D-Dur",cat:"instrumental",year:"1728",tracks:["Ouverture","Allemande","Courante","Aria","Sarabande","Menuett","Gigue"]},
  {bwv:"BWV 829",title:"Partita Nr. 5 fuer Klavier in G-Dur",cat:"instrumental",year:"1730",tracks:["Praeambulum","Allemande","Corrente","Sarabande","Tempo di Minuetta","Passepied","Gigue"]},
  {bwv:"BWV 830",title:"Partita Nr. 6 fuer Klavier in e-Moll",cat:"instrumental",year:"1730",tracks:["Toccata","Allemande","Corrente","Air","Sarabande","Tempo di Gavotta","Gigue"]},
  {bwv:"BWV 971",title:"Italienisches Konzert in F-Dur",cat:"instrumental",year:"1735",tracks:["Allegro","Andante","Presto"]},
  {bwv:"BWV 831",title:"Franzoesische Ouvertuere in h-Moll",cat:"instrumental",year:"1735",tracks:["Ouverture","Courante","Gavotte I/II","Passepied I/II","Sarabande","Bourree I/II","Gigue","Echo"]},
  {bwv:"BWV 1014",title:"Sonate fuer Violine und Cembalo Nr. 1 in h-Moll",cat:"instrumental",year:"1720",tracks:["Adagio","Allegro","Andante","Allegro"]},
  {bwv:"BWV 1015",title:"Sonate fuer Violine und Cembalo Nr. 2 in A-Dur",cat:"instrumental",year:"1720",tracks:["Dolce","Allegro","Andante un poco","Presto"]},
  {bwv:"BWV 1016",title:"Sonate fuer Violine und Cembalo Nr. 3 in E-Dur",cat:"instrumental",year:"1720",tracks:["Adagio","Allegro","Adagio ma non tanto","Allegro"]},
  // ---- ORGAN (~32) ----
  {bwv:"BWV 525",title:"Triosonate Nr. 1 in Es-Dur",cat:"organ",year:"1727",tracks:["Allegro moderato","Adagio","Allegro"]},
  {bwv:"BWV 526",title:"Triosonate Nr. 2 in c-Moll",cat:"organ",year:"1727",tracks:["Vivace","Largo","Allegro"]},
  {bwv:"BWV 527",title:"Triosonate Nr. 3 in d-Moll",cat:"organ",year:"1727",tracks:["Andante","Adagio e dolce","Vivace"]},
  {bwv:"BWV 528",title:"Triosonate Nr. 4 in e-Moll",cat:"organ",year:"1727",tracks:["Adagio - Vivace","Andante","Un poco Allegro"]},
  {bwv:"BWV 529",title:"Triosonate Nr. 5 in C-Dur",cat:"organ",year:"1727",tracks:["Allegro","Largo","Allegro"]},
  {bwv:"BWV 530",title:"Triosonate Nr. 6 in G-Dur",cat:"organ",year:"1727",tracks:["Vivace","Lento","Allegro"]},
  {bwv:"BWV 532",title:"Praeludium und Fuge in D-Dur",cat:"organ",year:"1710",tracks:["Praeludium","Fuge"]},
  {bwv:"BWV 534",title:"Praeludium und Fuge in f-Moll",cat:"organ",year:"1710",tracks:["Praeludium","Fuge"]},
  {bwv:"BWV 536",title:"Praeludium und Fuge in A-Dur",cat:"organ",year:"1710",tracks:["Praeludium","Fuge"]},
  {bwv:"BWV 537",title:"Fantasia und Fuge in c-Moll",cat:"organ",year:"1723",tracks:["Fantasia","Fuge"]},
  {bwv:"BWV 538",title:"Toccata und Fuge in d-Moll (Dorische)",cat:"organ",year:"1710",tracks:["Toccata","Fuge"]},
  {bwv:"BWV 540",title:"Toccata und Fuge in F-Dur",cat:"organ",year:"1714",tracks:["Toccata","Fuge"]},
  {bwv:"BWV 541",title:"Praeludium und Fuge in G-Dur",cat:"organ",year:"1715",tracks:["Praeludium","Fuge"]},
  {bwv:"BWV 542",title:"Fantasia und Fuge in g-Moll (Grosse)",cat:"organ",year:"1720",tracks:["Fantasia","Fuge"]},
  {bwv:"BWV 543",title:"Praeludium und Fuge in a-Moll",cat:"organ",year:"1710",tracks:["Praeludium","Fuge"]},
  {bwv:"BWV 544",title:"Praeludium und Fuge in h-Moll",cat:"organ",year:"1727",tracks:["Praeludium","Fuge"]},
  {bwv:"BWV 545",title:"Praeludium und Fuge in C-Dur",cat:"organ",year:"1710",tracks:["Praeludium","Fuge"]},
  {bwv:"BWV 546",title:"Praeludium und Fuge in c-Moll",cat:"organ",year:"1730",tracks:["Praeludium","Fuge"]},
  {bwv:"BWV 547",title:"Praeludium und Fuge in C-Dur (9/8)",cat:"organ",year:"1744",tracks:["Praeludium","Fuge"]},
  {bwv:"BWV 548",title:"Praeludium und Fuge in e-Moll (Wedge)",cat:"organ",year:"1730",tracks:["Praeludium","Fuge"]},
  {bwv:"BWV 552",title:"Praeludium und Fuge in Es-Dur (St. Anne)",cat:"organ",year:"1739",tracks:["Praeludium","Fuge"]},
  {bwv:"BWV 564",title:"Toccata, Adagio und Fuge in C-Dur",cat:"organ",year:"1710",tracks:["Toccata","Adagio","Fuge"]},
  {bwv:"BWV 565",title:"Toccata und Fuge in d-Moll",cat:"organ",year:"1708",tracks:["Toccata","Fuge"]},
  {bwv:"BWV 566",title:"Toccata und Fuge in E-Dur",cat:"organ",year:"1708",tracks:["Toccata","Fuge"]},
  {bwv:"BWV 572",title:"Fantasia in G-Dur (Piece d'Orgue)",cat:"organ",year:"1714",tracks:["Tres vitement","Gravement","Lentement"]},
  {bwv:"BWV 578",title:"Fuge in g-Moll (Kleine)",cat:"organ",year:"1707",tracks:["Fuge"]},
  {bwv:"BWV 582",title:"Passacaglia und Fuge in c-Moll",cat:"organ",year:"1710",tracks:["Passacaglia","Fuge"]},
  {bwv:"BWV 588",title:"Canzona in d-Moll",cat:"organ",year:"1710",tracks:["Canzona"]},
  {bwv:"BWV 590",title:"Pastorella in F-Dur",cat:"organ",year:"1720",tracks:["Allegro","Allemande","Aria","Gigue"]},
  {bwv:"BWV 596",title:"Konzert in d-Moll (nach Vivaldi)",cat:"organ",year:"1714",tracks:["Allegro","Grave","Fuge","Largo e spiccato","Allegro"]},
  {bwv:"BWV 599",title:"Orgel-Buechlein (Auswahl)",cat:"organ",year:"1715",tracks:["Nun komm, der Heiden Heiland","Gottes Sohn ist kommen","Herr Christ, der einig Gottes Sohn","Lob sei dem allmaecchtigen Gott"]},
  {bwv:"BWV 645",title:"Schubler-Choraele",cat:"organ",year:"1748",tracks:["Wachet auf, ruft uns die Stimme","Wo soll ich fliehen hin","Wer nur den lieben Gott laesst walten","Meine Seele erhebt den Herren","Ach bleib bei uns, Herr Jesu Christ","Kommst du nun, Jesu, vom Himmel herunter"]},
];

// ============================================================
// CATEGORY META
// ============================================================
const CAT_COLORS = {
  cantatas:     0xC9A84C,
  passions:     0xD4725C,
  oratorios:    0x6B9080,
  masses:       0x8B7EC8,
  instrumental: 0xC8956E,
  organ:        0x7BA0B8
};
const CAT_LABELS = {
  cantatas:'Kantaten', passions:'Passionen', oratorios:'Oratorien',
  masses:'Messen', instrumental:'Instrumental', organ:'Orgel'
};

// Constellation connections (related works)
const CONSTELLATIONS = [
  // Passions cluster
  ['BWV 244','BWV 245'],['BWV 244','BWV 247'],['BWV 245','BWV 246'],
  // Christmas-related
  ['BWV 248','BWV 110'],['BWV 248','BWV 151'],['BWV 248','BWV 40'],['BWV 248','BWV 62'],['BWV 248','BWV 213'],['BWV 248','BWV 214'],
  // Brandenburg set
  ['BWV 1046','BWV 1047'],['BWV 1047','BWV 1048'],['BWV 1048','BWV 1049'],['BWV 1049','BWV 1050'],['BWV 1050','BWV 1051'],['BWV 1046','BWV 1051'],
  // Orchestral suites
  ['BWV 1066','BWV 1067'],['BWV 1067','BWV 1068'],['BWV 1068','BWV 1069'],
  // Cello suites
  ['BWV 1007','BWV 1008'],['BWV 1008','BWV 1009'],['BWV 1009','BWV 1010'],['BWV 1010','BWV 1011'],['BWV 1011','BWV 1012'],
  // Solo violin
  ['BWV 1001','BWV 1002'],['BWV 1002','BWV 1003'],['BWV 1003','BWV 1004'],['BWV 1004','BWV 1005'],['BWV 1005','BWV 1006'],
  // Keyboard concertos
  ['BWV 1052','BWV 1053'],['BWV 1053','BWV 1054'],['BWV 1054','BWV 1055'],['BWV 1055','BWV 1056'],['BWV 1056','BWV 1057'],['BWV 1057','BWV 1058'],
  // Trio sonatas
  ['BWV 525','BWV 526'],['BWV 526','BWV 527'],['BWV 527','BWV 528'],['BWV 528','BWV 529'],['BWV 529','BWV 530'],
  // Masses
  ['BWV 232','BWV 233'],['BWV 233','BWV 234'],['BWV 234','BWV 235'],['BWV 235','BWV 236'],['BWV 232','BWV 243'],
  // Magnificat
  ['BWV 243','BWV 243a'],
  // Motets
  ['BWV 225','BWV 227'],['BWV 225','BWV 118'],
  // Keyboard partitas
  ['BWV 825','BWV 826'],['BWV 826','BWV 827'],['BWV 827','BWV 828'],['BWV 828','BWV 829'],['BWV 829','BWV 830'],
  // Late masterworks
  ['BWV 1079','BWV 1080'],['BWV 988','BWV 1080'],
  // Wachet auf pair
  ['BWV 140','BWV 645'],
  // Advent pair
  ['BWV 61','BWV 62'],
  // Was Gott tut pair
  ['BWV 99','BWV 100'],
  // Violin concertos
  ['BWV 1041','BWV 1042'],['BWV 1042','BWV 1043'],['BWV 1043','BWV 1044'],
  // Multiple concertos
  ['BWV 1060','BWV 1061'],['BWV 1061','BWV 1062'],['BWV 1063','BWV 1064'],['BWV 1064','BWV 1065'],
  // Passions to oratorios
  ['BWV 249','BWV 248'],
  // Violin sonatas to solo works
  ['BWV 1014','BWV 1015'],['BWV 1015','BWV 1016'],['BWV 1014','BWV 1001'],
  // WTC
  ['BWV 846','BWV 870'],
  // Italian/French
  ['BWV 971','BWV 831'],
  // Famous organ
  ['BWV 565','BWV 582'],['BWV 565','BWV 564'],['BWV 538','BWV 540'],['BWV 552','BWV 547'],
];

// ============================================================
// THREE.JS SETUP
// ============================================================
let scene, camera, renderer, controls;
let particleSystem, bgStars;
let raycaster, mouse;
let hoveredIndex = -1, selectedIndex = -1;
let constellationLines = null, showConstellations = false;
let idleTimer = 0, idleDrifting = false;
let introAnimating = true, introStartTime = 0;
let clock;
let filterCategory = 'all';
let searchTerm = '';
let particlePositions = []; // base positions for each work
let particleSizes = [];
let particleColors = [];
let bwvIndexMap = {};
let uniforms;

// Build BWV index
WORKS.forEach((w,i) => { bwvIndexMap[w.bwv] = i; });

function init() {
  clock = new THREE.Clock();
  scene = new THREE.Scene();
  scene.fog = new THREE.FogExp2(0x050308, 0.0025);

  camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 2000);
  camera.position.set(0, 0, 250); // will animate in

  renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setClearColor(0x050308);
  document.body.insertBefore(renderer.domElement, document.body.firstChild);

  // Raycaster
  raycaster = new THREE.Raycaster();
  raycaster.params.Points.threshold = 1.2;
  mouse = new THREE.Vector2(-999, -999);

  // ---- OrbitControls inline implementation ----
  initOrbitControls();

  // Create particles
  createParticles();
  createBackgroundStars();
  createConstellationLines();

  // Events
  window.addEventListener('resize', onResize);
  renderer.domElement.addEventListener('mousemove', onMouseMove);
  renderer.domElement.addEventListener('click', onClick);
  renderer.domElement.addEventListener('touchstart', onTouch, { passive: true });
  document.getElementById('searchInput').addEventListener('input', onSearch);
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', onFilter);
  });
  document.getElementById('constellationToggle').addEventListener('click', toggleConstellations);
  document.getElementById('detailClose').addEventListener('click', closeDetail);
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetail(); });

  // Start
  introStartTime = performance.now();
  updateLoading(100);
  setTimeout(() => {
    document.getElementById('loadingOverlay').classList.add('fade');
    setTimeout(() => {
      document.getElementById('loadingOverlay').style.display = 'none';
    }, 1300);
  }, 600);

  animate();
}

// ============================================================
// ORBIT CONTROLS (inline, simplified)
// ============================================================
function initOrbitControls() {
  controls = {
    target: new THREE.Vector3(0, 0, 0),
    spherical: { radius: 120, phi: Math.PI / 2, theta: 0 },
    sphericalDelta: { phi: 0, theta: 0 },
    scale: 1,
    panOffset: new THREE.Vector3(),
    isDown: false,
    isDragging: false,
    rotateSpeed: 0.005,
    panSpeed: 0.3,
    zoomSpeed: 1.1,
    minDistance: 20,
    maxDistance: 400,
    button: -1,
    startX: 0, startY: 0,
    enableDamping: true,
    dampingFactor: 0.08,
    autoRotateSpeed: 0.0004,
    autoRotate: false,

    update: function() {
      const offset = new THREE.Vector3();
      offset.copy(camera.position).sub(this.target);
      let r = offset.length();
      let theta = Math.atan2(offset.x, offset.z);
      let phi = Math.acos(Math.max(-1, Math.min(1, offset.y / r)));

      theta += this.sphericalDelta.theta;
      phi += this.sphericalDelta.phi;
      phi = Math.max(0.01, Math.min(Math.PI - 0.01, phi));

      r *= this.scale;
      r = Math.max(this.minDistance, Math.min(this.maxDistance, r));

      this.target.add(this.panOffset);

      offset.x = r * Math.sin(phi) * Math.sin(theta);
      offset.y = r * Math.cos(phi);
      offset.z = r * Math.sin(phi) * Math.cos(theta);

      camera.position.copy(this.target).add(offset);
      camera.lookAt(this.target);

      if (this.enableDamping) {
        this.sphericalDelta.theta *= (1 - this.dampingFactor);
        this.sphericalDelta.phi *= (1 - this.dampingFactor);
        this.panOffset.multiplyScalar(1 - this.dampingFactor);
      } else {
        this.sphericalDelta.theta = 0;
        this.sphericalDelta.phi = 0;
        this.panOffset.set(0, 0, 0);
      }
      this.scale = 1;
    }
  };

  const el = renderer.domElement;

  el.addEventListener('pointerdown', function(e) {
    controls.isDown = true;
    controls.isDragging = false;
    controls.button = e.button;
    controls.startX = e.clientX;
    controls.startY = e.clientY;
    resetIdle();
  });

  window.addEventListener('pointermove', function(e) {
    if (!controls.isDown) return;
    const dx = e.clientX - controls.startX;
    const dy = e.clientY - controls.startY;
    if (Math.abs(dx) > 2 || Math.abs(dy) > 2) controls.isDragging = true;
    controls.startX = e.clientX;
    controls.startY = e.clientY;

    if (controls.button === 0) {
      // rotate
      controls.sphericalDelta.theta -= dx * controls.rotateSpeed;
      controls.sphericalDelta.phi -= dy * controls.rotateSpeed;
    } else if (controls.button === 2 || controls.button === 1) {
      // pan
      const offset = new THREE.Vector3();
      offset.copy(camera.position).sub(controls.target);
      let dist = offset.length();
      let panX = -dx * controls.panSpeed * dist * 0.001;
      let panY = dy * controls.panSpeed * dist * 0.001;
      const right = new THREE.Vector3();
      right.setFromMatrixColumn(camera.matrix, 0);
      const up = new THREE.Vector3();
      up.setFromMatrixColumn(camera.matrix, 1);
      controls.panOffset.add(right.multiplyScalar(panX));
      controls.panOffset.add(up.multiplyScalar(panY));
    }
    resetIdle();
  });

  window.addEventListener('pointerup', function() {
    controls.isDown = false;
  });

  el.addEventListener('wheel', function(e) {
    e.preventDefault();
    if (e.deltaY < 0) {
      controls.scale /= controls.zoomSpeed;
    } else {
      controls.scale *= controls.zoomSpeed;
    }
    resetIdle();
  }, { passive: false });

  el.addEventListener('contextmenu', e => e.preventDefault());

  // Touch support
  let lastTouchDist = 0;
  let lastTouchX = 0, lastTouchY = 0;
  el.addEventListener('touchstart', function(e) {
    controls.isDown = true;
    if (e.touches.length === 1) {
      controls.button = 0;
      controls.startX = e.touches[0].clientX;
      controls.startY = e.touches[0].clientY;
      lastTouchX = controls.startX;
      lastTouchY = controls.startY;
    } else if (e.touches.length === 2) {
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      lastTouchDist = Math.sqrt(dx*dx + dy*dy);
    }
    resetIdle();
  }, { passive: true });

  el.addEventListener('touchmove', function(e) {
    if (e.touches.length === 1) {
      const dx = e.touches[0].clientX - lastTouchX;
      const dy = e.touches[0].clientY - lastTouchY;
      lastTouchX = e.touches[0].clientX;
      lastTouchY = e.touches[0].clientY;
      controls.sphericalDelta.theta -= dx * controls.rotateSpeed;
      controls.sphericalDelta.phi -= dy * controls.rotateSpeed;
      controls.isDragging = true;
    } else if (e.touches.length === 2) {
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if (lastTouchDist > 0) {
        const ratio = lastTouchDist / dist;
        controls.scale *= ratio;
      }
      lastTouchDist = dist;
    }
    resetIdle();
  }, { passive: true });

  el.addEventListener('touchend', function() {
    controls.isDown = false;
    lastTouchDist = 0;
  }, { passive: true });
}

// ============================================================
// PARTICLE CREATION
// ============================================================
function createParticles() {
  const count = WORKS.length;
  const positions = new Float32Array(count * 3);
  const colors = new Float32Array(count * 3);
  const sizes = new Float32Array(count);
  const alphas = new Float32Array(count);
  const pulses = new Float32Array(count);

  particlePositions = [];
  particleSizes = [];
  particleColors = [];

  for (let i = 0; i < count; i++) {
    const w = WORKS[i];
    const col = new THREE.Color(CAT_COLORS[w.cat]);
    let pos;

    switch (w.cat) {
      case 'passions': {
        // Center, bright, small cluster
        const a = (i - WORKS.findIndex(x => x.cat === 'passions')) * (Math.PI * 2 / 5);
        const r = 2 + Math.random() * 3;
        pos = new THREE.Vector3(
          Math.cos(a) * r + (Math.random() - 0.5) * 2,
          (Math.random() - 0.5) * 3,
          Math.sin(a) * r + (Math.random() - 0.5) * 2
        );
        sizes[i] = 4.5 + Math.random() * 1.5;
        break;
      }
      case 'cantatas': {
        // Spiral arm
        const idx = i - WORKS.findIndex(x => x.cat === 'cantatas');
        const t = idx / 60;
        const spiralAngle = t * Math.PI * 4 + 0.5;
        const spiralRadius = 12 + t * 55;
        pos = new THREE.Vector3(
          Math.cos(spiralAngle) * spiralRadius + (Math.random() - 0.5) * 6,
          (Math.random() - 0.5) * 8 + Math.sin(spiralAngle * 0.5) * 3,
          Math.sin(spiralAngle) * spiralRadius + (Math.random() - 0.5) * 6
        );
        sizes[i] = 2.0 + Math.random() * 1.2;
        break;
      }
      case 'oratorios': {
        const a = (i - WORKS.findIndex(x => x.cat === 'oratorios')) * (Math.PI * 2 / 8);
        const r = 15 + Math.random() * 10;
        pos = new THREE.Vector3(
          Math.cos(a) * r + (Math.random() - 0.5) * 4,
          (Math.random() - 0.5) * 6 + 5,
          Math.sin(a) * r + (Math.random() - 0.5) * 4
        );
        sizes[i] = 3.0 + Math.random() * 1.0;
        break;
      }
      case 'masses': {
        const a = (i - WORKS.findIndex(x => x.cat === 'masses')) * (Math.PI * 2 / 12);
        const r = 20 + Math.random() * 12;
        pos = new THREE.Vector3(
          Math.cos(a + 1.2) * r + (Math.random() - 0.5) * 5,
          (Math.random() - 0.5) * 7 - 3,
          Math.sin(a + 1.2) * r + (Math.random() - 0.5) * 5
        );
        sizes[i] = 2.8 + Math.random() * 0.8;
        break;
      }
      case 'instrumental': {
        const idx = i - WORKS.findIndex(x => x.cat === 'instrumental');
        const a = idx * (Math.PI * 2 / 55) * 2.5;
        const r = 30 + idx * 0.6 + Math.random() * 8;
        pos = new THREE.Vector3(
          Math.cos(a) * r + (Math.random() - 0.5) * 5,
          (Math.random() - 0.5) * 15,
          Math.sin(a) * r + (Math.random() - 0.5) * 5
        );
        sizes[i] = 2.2 + Math.random() * 1.0;
        break;
      }
      case 'organ': {
        const idx = i - WORKS.findIndex(x => x.cat === 'organ');
        const a = idx * (Math.PI * 2 / 32) + Math.PI * 0.3;
        const r = 45 + Math.random() * 15;
        pos = new THREE.Vector3(
          Math.cos(a) * r + (Math.random() - 0.5) * 6,
          (Math.random() - 0.5) * 12 - 5,
          Math.sin(a) * r + (Math.random() - 0.5) * 6
        );
        sizes[i] = 2.0 + Math.random() * 0.8;
        break;
      }
      default: {
        pos = new THREE.Vector3(
          (Math.random() - 0.5) * 80,
          (Math.random() - 0.5) * 80,
          (Math.random() - 0.5) * 80
        );
        sizes[i] = 2.0;
      }
    }

    particlePositions.push(pos.clone());
    particleSizes.push(sizes[i]);
    particleColors.push(col.clone());

    positions[i * 3] = pos.x;
    positions[i * 3 + 1] = pos.y;
    positions[i * 3 + 2] = pos.z;

    colors[i * 3] = col.r;
    colors[i * 3 + 1] = col.g;
    colors[i * 3 + 2] = col.b;

    alphas[i] = 1.0;
    pulses[i] = Math.random() * Math.PI * 2; // phase offset
  }

  const geometry = new THREE.BufferGeometry();
  geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
  geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
  geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
  geometry.setAttribute('alpha', new THREE.BufferAttribute(alphas, 1));
  geometry.setAttribute('pulse', new THREE.BufferAttribute(pulses, 1));

  // Custom shader
  uniforms = {
    uTime: { value: 0 },
    uHovered: { value: -1.0 },
    uPixelRatio: { value: Math.min(window.devicePixelRatio, 2) }
  };

  const vertexShader = `
    attribute float size;
    attribute float alpha;
    attribute float pulse;
    uniform float uTime;
    uniform float uHovered;
    uniform float uPixelRatio;
    varying vec3 vColor;
    varying float vAlpha;
    varying float vGlow;
    void main() {
      vColor = color;
      vAlpha = alpha;
      vGlow = 0.0;
      float idx = float(gl_VertexID);
      float s = size;
      // Gentle idle pulse
      s += sin(uTime * 0.8 + pulse * 6.2831) * 0.3;
      // Hover pulse
      if (abs(idx - uHovered) < 0.5) {
        s += sin(uTime * 4.0) * 1.5 + 2.0;
        vGlow = 1.0;
      }
      vec4 mvPos = modelViewMatrix * vec4(position, 1.0);
      gl_PointSize = s * uPixelRatio * (200.0 / -mvPos.z);
      gl_PointSize = max(gl_PointSize, 1.0);
      gl_Position = projectionMatrix * mvPos;
    }
  `;

  const fragmentShader = `
    varying vec3 vColor;
    varying float vAlpha;
    varying float vGlow;
    void main() {
      float d = length(gl_PointCoord - 0.5) * 2.0;
      if (d > 1.0) discard;
      // Soft glow
      float core = 1.0 - smoothstep(0.0, 0.3, d);
      float halo = 1.0 - smoothstep(0.0, 1.0, d);
      float glow = core * 0.7 + halo * 0.3;
      // Extra glow on hover
      if (vGlow > 0.5) {
        glow = core * 0.5 + halo * 0.5;
        glow = pow(glow, 0.6);
      }
      gl_FragColor = vec4(vColor * glow * 1.2, glow * vAlpha);
    }
  `;

  const material = new THREE.ShaderMaterial({
    uniforms: uniforms,
    vertexShader: vertexShader,
    fragmentShader: fragmentShader,
    vertexColors: true,
    transparent: true,
    blending: THREE.AdditiveBlending,
    depthWrite: false
  });

  particleSystem = new THREE.Points(geometry, material);
  scene.add(particleSystem);
}

// ============================================================
// BACKGROUND STARS
// ============================================================
function createBackgroundStars() {
  const count = 2000;
  const positions = new Float32Array(count * 3);
  const colors = new Float32Array(count * 3);
  const sizes = new Float32Array(count);

  for (let i = 0; i < count; i++) {
    // Random on sphere shell, far away
    const theta = Math.random() * Math.PI * 2;
    const phi = Math.acos(2 * Math.random() - 1);
    const r = 300 + Math.random() * 500;
    positions[i * 3] = r * Math.sin(phi) * Math.cos(theta);
    positions[i * 3 + 1] = r * Math.sin(phi) * Math.sin(theta);
    positions[i * 3 + 2] = r * Math.cos(phi);

    const brightness = 0.15 + Math.random() * 0.35;
    // Slight warm/cool tint
    const tint = Math.random();
    if (tint < 0.3) {
      colors[i * 3] = brightness * 1.1;
      colors[i * 3 + 1] = brightness * 0.95;
      colors[i * 3 + 2] = brightness * 0.85;
    } else if (tint < 0.6) {
      colors[i * 3] = brightness * 0.85;
      colors[i * 3 + 1] = brightness * 0.9;
      colors[i * 3 + 2] = brightness * 1.1;
    } else {
      colors[i * 3] = brightness;
      colors[i * 3 + 1] = brightness;
      colors[i * 3 + 2] = brightness;
    }

    sizes[i] = 0.3 + Math.random() * 0.8;
  }

  const geo = new THREE.BufferGeometry();
  geo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
  geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
  geo.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

  const vShader = `
    attribute float size;
    varying vec3 vColor;
    uniform float uTime;
    void main() {
      vColor = color;
      vec4 mvPos = modelViewMatrix * vec4(position, 1.0);
      float flicker = 0.7 + 0.3 * sin(uTime * 0.5 + position.x * 0.1 + position.y * 0.15);
      gl_PointSize = size * flicker * (150.0 / -mvPos.z) * ${Math.min(window.devicePixelRatio, 2).toFixed(1)};
      gl_PointSize = max(gl_PointSize, 0.5);
      gl_Position = projectionMatrix * mvPos;
    }
  `;
  const fShader = `
    varying vec3 vColor;
    void main() {
      float d = length(gl_PointCoord - 0.5) * 2.0;
      if (d > 1.0) discard;
      float a = 1.0 - smoothstep(0.0, 1.0, d);
      gl_FragColor = vec4(vColor, a * 0.6);
    }
  `;

  const mat = new THREE.ShaderMaterial({
    uniforms: { uTime: uniforms.uTime },
    vertexShader: vShader,
    fragmentShader: fShader,
    vertexColors: true,
    transparent: true,
    blending: THREE.AdditiveBlending,
    depthWrite: false
  });

  bgStars = new THREE.Points(geo, mat);
  scene.add(bgStars);
}

// ============================================================
// CONSTELLATION LINES
// ============================================================
function createConstellationLines() {
  const verts = [];
  const cols = [];
  for (const [bwv1, bwv2] of CONSTELLATIONS) {
    const i1 = bwvIndexMap[bwv1];
    const i2 = bwvIndexMap[bwv2];
    if (i1 === undefined || i2 === undefined) continue;
    const p1 = particlePositions[i1];
    const p2 = particlePositions[i2];
    verts.push(p1.x, p1.y, p1.z, p2.x, p2.y, p2.z);
    const c1 = particleColors[i1];
    const c2 = particleColors[i2];
    cols.push(c1.r, c1.g, c1.b, c2.r, c2.g, c2.b);
  }

  const geo = new THREE.BufferGeometry();
  geo.setAttribute('position', new THREE.Float32BufferAttribute(verts, 3));
  geo.setAttribute('color', new THREE.Float32BufferAttribute(cols, 3));

  const mat = new THREE.LineBasicMaterial({
    vertexColors: true,
    transparent: true,
    opacity: 0.0,
    blending: THREE.AdditiveBlending,
    depthWrite: false
  });

  constellationLines = new THREE.LineSegments(geo, mat);
  scene.add(constellationLines);
}

// ============================================================
// INTERACTION
// ============================================================
function onMouseMove(e) {
  mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
  resetIdle();

  // Tooltip position
  const tooltip = document.getElementById('tooltip');
  tooltip.style.left = (e.clientX + 15) + 'px';
  tooltip.style.top = (e.clientY - 10) + 'px';
}

function onTouch(e) {
  if (e.touches.length === 1) {
    const t = e.touches[0];
    mouse.x = (t.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(t.clientY / window.innerHeight) * 2 + 1;
  }
}

function onClick(e) {
  if (controls.isDragging) return;
  if (hoveredIndex >= 0) {
    selectedIndex = hoveredIndex;
    showDetail(selectedIndex);
  } else {
    closeDetail();
  }
}

function onSearch(e) {
  searchTerm = e.target.value.toLowerCase().trim();
  applyFilters();
}

function onFilter(e) {
  const cat = e.target.dataset.cat;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  e.target.classList.add('active');
  filterCategory = cat;
  applyFilters();
}

function toggleConstellations() {
  showConstellations = !showConstellations;
  document.getElementById('constellationToggle').classList.toggle('active', showConstellations);
}

function applyFilters() {
  const alphaAttr = particleSystem.geometry.getAttribute('alpha');
  const sizeAttr = particleSystem.geometry.getAttribute('size');
  for (let i = 0; i < WORKS.length; i++) {
    const w = WORKS[i];
    let visible = true;
    if (filterCategory !== 'all' && w.cat !== filterCategory) visible = false;
    if (searchTerm) {
      const haystack = (w.bwv + ' ' + w.title + ' ' + CAT_LABELS[w.cat]).toLowerCase();
      if (!haystack.includes(searchTerm)) visible = false;
    }
    alphaAttr.array[i] = visible ? 1.0 : 0.05;
    sizeAttr.array[i] = visible ? particleSizes[i] : particleSizes[i] * 0.3;
  }
  alphaAttr.needsUpdate = true;
  sizeAttr.needsUpdate = true;
}

// ============================================================
// DETAIL PANEL
// ============================================================
function showDetail(idx) {
  const w = WORKS[idx];
  const panel = document.getElementById('detailPanel');
  const col = '#' + CAT_COLORS[w.cat].toString(16).padStart(6, '0');

  document.getElementById('dpCategory').textContent = CAT_LABELS[w.cat];
  document.getElementById('dpCategory').style.color = col;
  document.getElementById('dpBwv').textContent = w.bwv;
  document.getElementById('dpTitle').textContent = w.title;
  document.getElementById('dpYear').textContent = 'ca. ' + w.year + '  |  Rilling / Bach-Collegium Stuttgart';

  // Tracks
  const ol = document.getElementById('dpTrackList');
  ol.innerHTML = '';
  w.tracks.forEach(t => {
    const li = document.createElement('li');
    li.textContent = t;
    ol.appendChild(li);
  });

  // Streaming links
  const ytQuery = encodeURIComponent('Helmuth Rilling ' + w.title + ' ' + w.bwv);
  document.getElementById('dpYouTube').href = 'https://www.youtube.com/results?search_query=' + ytQuery;
  document.getElementById('dpSpotify').href = 'https://open.spotify.com/search/' + ytQuery;
  document.getElementById('dpAmazon').href = 'https://music.amazon.com/search/' + ytQuery;

  // Geometric pattern
  drawPattern(idx, col);

  panel.classList.add('open');
}

function closeDetail() {
  document.getElementById('detailPanel').classList.remove('open');
  selectedIndex = -1;
}

function drawPattern(idx, color) {
  const canvas = document.getElementById('patternCanvas');
  const ctx = canvas.getContext('2d');
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  canvas.width = w * 2;
  canvas.height = h * 2;
  ctx.scale(2, 2);

  ctx.fillStyle = '#0a080c';
  ctx.fillRect(0, 0, w, h);

  const work = WORKS[idx];
  const bwvNum = parseInt(work.bwv.replace('BWV ', '').replace('a', '')) || 100;
  const seed = bwvNum * 137;

  // Seeded random
  let rng = seed;
  function srand() {
    rng = (rng * 16807 + 0) % 2147483647;
    return (rng & 0x7fffffff) / 0x7fffffff;
  }

  const cx = w / 2;
  const cy = h / 2;
  const maxR = Math.min(w, h) * 0.4;

  ctx.globalCompositeOperation = 'lighter';
  ctx.strokeStyle = color;
  ctx.lineWidth = 0.5;

  // Category-specific patterns
  const nTracks = work.tracks.length;
  const cat = work.cat;

  if (cat === 'passions') {
    // Cross pattern radiating outward
    ctx.globalAlpha = 0.3;
    for (let j = 0; j < nTracks * 3; j++) {
      const angle = (j / (nTracks * 3)) * Math.PI * 2;
      const r1 = srand() * maxR * 0.3;
      const r2 = maxR * (0.5 + srand() * 0.5);
      ctx.beginPath();
      ctx.moveTo(cx + Math.cos(angle) * r1, cy + Math.sin(angle) * r1);
      ctx.lineTo(cx + Math.cos(angle) * r2, cy + Math.sin(angle) * r2);
      ctx.stroke();
    }
    // Central cross
    ctx.globalAlpha = 0.5;
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(cx, cy - maxR * 0.8);
    ctx.lineTo(cx, cy + maxR * 0.8);
    ctx.moveTo(cx - maxR * 0.5, cy - maxR * 0.15);
    ctx.lineTo(cx + maxR * 0.5, cy - maxR * 0.15);
    ctx.stroke();
  } else if (cat === 'cantatas' || cat === 'oratorios') {
    // Circular mandala
    const arms = Math.max(nTracks, 4);
    ctx.globalAlpha = 0.2;
    for (let layer = 0; layer < 5; layer++) {
      const lr = maxR * (0.2 + layer * 0.18);
      ctx.beginPath();
      for (let j = 0; j <= arms; j++) {
        const a = (j / arms) * Math.PI * 2 + layer * 0.3;
        const r = lr + srand() * 8 - 4;
        const x = cx + Math.cos(a) * r;
        const y = cy + Math.sin(a) * r;
        j === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.closePath();
      ctx.stroke();
    }
    // Connecting lines
    ctx.globalAlpha = 0.15;
    for (let j = 0; j < arms; j++) {
      const a = (j / arms) * Math.PI * 2;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx + Math.cos(a) * maxR, cy + Math.sin(a) * maxR);
      ctx.stroke();
    }
  } else if (cat === 'masses') {
    // Arched gothic window
    ctx.globalAlpha = 0.25;
    for (let j = 0; j < nTracks; j++) {
      const xOff = (j / nTracks - 0.5) * w * 0.7;
      ctx.beginPath();
      ctx.moveTo(cx + xOff, cy + maxR * 0.8);
      ctx.quadraticCurveTo(cx + xOff, cy - maxR, cx + xOff + w * 0.7 / nTracks, cy + maxR * 0.8);
      ctx.stroke();
    }
    ctx.globalAlpha = 0.15;
    for (let r = 0; r < 6; r++) {
      ctx.beginPath();
      ctx.arc(cx, cy, maxR * (0.15 + r * 0.15), 0, Math.PI * 2);
      ctx.stroke();
    }
  } else if (cat === 'instrumental') {
    // Wave interference pattern
    ctx.globalAlpha = 0.15;
    for (let j = 0; j < nTracks * 4; j++) {
      ctx.beginPath();
      const freq = 0.02 + srand() * 0.05;
      const amp = 10 + srand() * 30;
      const phase = srand() * Math.PI * 2;
      const yBase = h * (0.15 + (j / (nTracks * 4)) * 0.7);
      for (let x = 0; x < w; x += 2) {
        const y = yBase + Math.sin(x * freq + phase) * amp;
        x === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.stroke();
    }
  } else if (cat === 'organ') {
    // Pipe-like vertical lines with resonance circles
    ctx.globalAlpha = 0.2;
    const pipes = Math.max(nTracks * 2, 8);
    for (let j = 0; j < pipes; j++) {
      const x = w * (0.1 + (j / pipes) * 0.8);
      const pipeH = maxR * (0.5 + srand() * 0.5);
      ctx.beginPath();
      ctx.moveTo(x, cy + pipeH);
      ctx.lineTo(x, cy - pipeH);
      ctx.stroke();
      // resonance
      ctx.globalAlpha = 0.08;
      ctx.beginPath();
      ctx.arc(x, cy - pipeH, srand() * 10 + 3, 0, Math.PI * 2);
      ctx.stroke();
      ctx.globalAlpha = 0.2;
    }
  }

  // BWV number watermark
  ctx.globalCompositeOperation = 'source-over';
  ctx.globalAlpha = 0.08;
  ctx.fillStyle = color;
  ctx.font = `bold ${Math.min(w,h)*0.35}px 'Bodoni Moda', serif`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(bwvNum.toString(), cx, cy);
  ctx.globalAlpha = 1;
}

// ============================================================
// IDLE DRIFT
// ============================================================
function resetIdle() {
  idleTimer = 0;
  idleDrifting = false;
  controls.autoRotate = false;
}

// ============================================================
// LOADING
// ============================================================
function updateLoading(pct) {
  document.getElementById('loadFill').style.width = pct + '%';
}

// ============================================================
// RESIZE
// ============================================================
function onResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
  uniforms.uPixelRatio.value = Math.min(window.devicePixelRatio, 2);
}

// ============================================================
// ANIMATION LOOP
// ============================================================
function animate() {
  requestAnimationFrame(animate);

  const dt = clock.getDelta();
  const elapsed = clock.getElapsedTime();
  uniforms.uTime.value = elapsed;

  // ---- Intro camera fly-in ----
  if (introAnimating) {
    const t = Math.min((performance.now() - introStartTime) / 3500, 1);
    const ease = 1 - Math.pow(1 - t, 3); // easeOutCubic
    const startZ = 250;
    const endZ = 120;
    camera.position.set(
      Math.sin(ease * 0.3) * 20 * (1 - ease),
      15 * (1 - ease),
      startZ + (endZ - startZ) * ease
    );
    camera.lookAt(controls.target);
    if (t >= 1) {
      introAnimating = false;
    }
  } else {
    // ---- Idle drift ----
    idleTimer += dt;
    if (idleTimer > 30 && !idleDrifting) {
      idleDrifting = true;
      controls.autoRotate = true;
    }
    if (idleDrifting) {
      controls.sphericalDelta.theta += controls.autoRotateSpeed;
      controls.sphericalDelta.phi += Math.sin(elapsed * 0.1) * 0.00005;
    }

    controls.update();
  }

  // ---- Slow global rotation ----
  if (particleSystem) {
    particleSystem.rotation.y += 0.0001;
    if (bgStars) bgStars.rotation.y += 0.00003;
    if (constellationLines) constellationLines.rotation.y = particleSystem.rotation.y;
  }

  // ---- Constellation lines fade ----
  if (constellationLines) {
    const targetOpacity = showConstellations ? 0.2 : 0.0;
    constellationLines.material.opacity += (targetOpacity - constellationLines.material.opacity) * 0.05;
  }

  // ---- Raycasting ----
  if (!introAnimating) {
    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObject(particleSystem);
    const tooltip = document.getElementById('tooltip');

    if (intersects.length > 0) {
      const idx = intersects[0].index;
      const alphaArr = particleSystem.geometry.getAttribute('alpha').array;
      if (alphaArr[idx] > 0.5) {
        hoveredIndex = idx;
        uniforms.uHovered.value = idx;
        renderer.domElement.style.cursor = 'pointer';

        const w = WORKS[idx];
        tooltip.querySelector('.tt-bwv').textContent = w.bwv;
        tooltip.querySelector('.tt-title').textContent = w.title;
        tooltip.querySelector('.tt-year').textContent = 'ca. ' + w.year + '  ·  ' + CAT_LABELS[w.cat];
        tooltip.classList.add('visible');
      } else {
        hoveredIndex = -1;
        uniforms.uHovered.value = -1;
        renderer.domElement.style.cursor = 'default';
        tooltip.classList.remove('visible');
      }
    } else {
      hoveredIndex = -1;
      uniforms.uHovered.value = -1;
      renderer.domElement.style.cursor = 'default';
      tooltip.classList.remove('visible');
    }
  }

  // ---- FPS counter ----
  if (Math.floor(elapsed) % 2 === 0) {
    const visCount = WORKS.filter((w, i) => {
      const a = particleSystem.geometry.getAttribute('alpha').array[i];
      return a > 0.5;
    }).length;
    document.getElementById('stats').textContent = visCount + ' / 172 CDs';
  }

  renderer.render(scene, camera);
}

// ============================================================
// BOOT
// ============================================================
updateLoading(30);
window.addEventListener('DOMContentLoaded', () => {
  updateLoading(60);
  // Small delay so fonts load
  setTimeout(() => {
    updateLoading(90);
    init();
  }, 300);
});
</script>

<script>if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js');</script>
</body>
</html>
